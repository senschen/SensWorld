<!DOCTYPE HTML>
<html lang="zh-hans">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="renderer" content="webkit" />
    <title>Sens World</title>
    <link rel="stylesheet" href="static/css/index.css" />
</head>
<body>
<div class="preload-block">
    <img src="http://i2.muimg.com/4851/24d05b63045ffd02.jpg" />
</div>

<div class="welcome-block j-welcome-block">
    <div class="welcome-block-main rel">
        <div class="welcome-box-center j-welcome-box-center">
            <span class="welcome-text j-welcome-text line1">额，趁现在资源还在加载</span>
            <span class="welcome-text j-welcome-text line2">我先给你讲一个冷笑话</span>
            <span class="welcome-text j-welcome-text line3">有一个叫程思序的人</span>
            <span class="welcome-text j-welcome-text line4">整天思程序</span>
            <span class="welcome-text j-welcome-text line5">．．．．．．</span>
            <span class="welcome-text j-welcome-text line6">好尴尬，我们来看看资源加载完没有</span>
            <span class="welcome-text j-welcome-text line7 fail">哇塞，居然没加载完！</span>
            <span class="welcome-text j-welcome-text line7 success">哇塞，已经加载完了！</span>
            <span class="welcome-text j-welcome-text line8 fail">不管了，直接开始吧！</span>
            <span class="welcome-text j-welcome-text line8 success">那我们就立刻开始吧！</span>
            <span class="welcome-text-line">|</span>
            <div class="welcome-btn-start"></div>
        </div>

        <div class="welcome-box-btn j-welcome-box-btn hide">
            <input placeholder="" type="checkbox">
            <span class="welcome-btn"></span>
            <p class="welcome-text-tip">接下来记得使用滚轮哟</p>
        </div>
    </div>
</div>
<div class="j-sky-block">
    <div id="j-wrapper-block-back" class="wrapper-block">
        <div id="j-stage-block-back" class="stage-block-back">
            <img src="http://i2.muimg.com/4851/24d05b63045ffd02.jpg" ondragstart="return false"
                 class="wrapper-img j-wrapper-img-back"/>
            <canvas id="wrapper-cvs" class="wrapper-cvs j-wrapper-cvs"></canvas>
        </div>
    </div>
    <div class="wrapper-block-main j-wrapper-block-main">
        <div class="stage-block-main j-stage-block-main">
            <div class="stage-box-earth j-stage-box-earth">
                <img src="http://i2.muimg.com/4851/30acc09acf1e627f.png" alt="" class="j-stage-img-earth">
            </div>
            <div class="wrapper-box-link">呵呵</div>
        </div>
    </div>
</div>

<div class="intro-block j-intro-block hide">
    <div class="style-block"></div>
    <pre class="display-block">
    </pre>
    <div class="intro-box"></div>
</div>

<script src="http://libs.baidu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="static/js/MusicVisualizer.js"></script>
<script src="static/js/makeSky.js"></script>
<script src="static/js/breakImg.js"></script>
<script>
    var Cookie = (function () {
        function setCookie(name, value, day) {
            var oDate = new Date();
            oDate.setDate(oDate.getDate() + day);
            document.cookie = name + '=' + value + ';expires=' + oDate;
        }
        function delCookie(name) {
            setCookie(name, 1, -1);
        }
        function getCookie(name) {
            var arr = document.cookie.split('; ');
            for(var i = 0; i < arr.length; i++) {
                var arrName = arr[i].split('=');
                if(arrName[0] == name) {
                    return arrName[1];
                }
            }
            return '';
        }
        return {
            set: setCookie,
            del: delCookie,
            get: getCookie
        }
    })();

    var runPrefixMethod = function(element, method) {
        var usablePrefixMethod;
        ["webkit", "moz", "ms", "o", ""].forEach(function(prefix) {
            if (usablePrefixMethod) return;
            if (prefix === "") {
                method = method.slice(0,1).toLowerCase() + 	method.slice(1);
            }

            var typePrefixMethod = typeof element[prefix + method];

            if (typePrefixMethod + "" !== "undefined") {
                if (typePrefixMethod === "function") {
                    usablePrefixMethod = element[prefix + method]();
                } else {
                    usablePrefixMethod = element[prefix + method];
                }
            }
        });

        return usablePrefixMethod;
    };

    var prmFirst = new Promise(function (resolve) {
        var step = 0;
        var isLoaded = false;
        var lastSum = 0;

        var mv = new MusicVisualizer({
            size: 128,
            visualizer: function (arr) {
                if(step === 3) return;
                var sum = arr.reduce(function (prevResult, item) {
                    return prevResult + item;
                });
                if (sum > 5000) {
                    if(lastSum - sum > 500){
                        $('.j-wrapper-block-main').css({
                            'transform': 'scale(0.5)'
                        });

                        lastSum = sum;
                    }
                    else if(sum - lastSum > 200){
                        $('.j-wrapper-block-main').css({
                            'transform': 'scale(' + (0.5 + 2*(sum - lastSum) / 10000) + ')'
                        });
                        lastSum= sum;
                    }
                }
                else {
                    $('.j-wrapper-block-main').css({
                        'transform': 'scale(0.5)'
                    });
                    lastSum = sum;
                }
            }
        });
        mv.play('static/res/Routine.mp3',function () {
            isLoaded = true;
            if(step > 0){
                mv.start();
            }
        });

        if(!Cookie.get('finished')){
            var welComeText = document.getElementsByClassName('j-welcome-text');
            [].forEach.call(welComeText,function (item) {
                item.classList.add('play');
            });

            setTimeout(function () {
                var _removeFlagStr = isLoaded ? 'fail' : 'success';
                [].forEach.call(welComeText, function (item) {
                    if (item.classList.contains(_removeFlagStr)) {
                        item.remove();
                    }
                });
            },8000);
            //welcome-box-center
            setTimeout(function () {
                document.getElementsByClassName('j-welcome-box-center')[0].classList.add('die');
                setTimeout(function () {
                    document.getElementsByClassName('j-welcome-box-center')[0].remove();
                    document.getElementsByClassName('j-welcome-box-btn')[0].classList.remove('hide');
                    document.getElementsByClassName('j-welcome-box-btn')[0].classList.add('show');
                },1800);
            },11000);
        }
        else {
            document.getElementsByClassName('j-welcome-box-center')[0].remove();
            document.getElementsByClassName('j-welcome-box-btn')[0].classList.remove('hide');
            document.getElementsByClassName('j-welcome-box-btn')[0].classList.add('show');
        }

        function step2() {
            step = 1;

            if(isLoaded){
                mv.start();
            }

            document.getElementsByClassName('j-welcome-block')[0].classList.add('fadeout');
            makeSky.init(function (far) {
                if (step === 1 && far > 200) {
                    step = 2;
                    $('.j-wrapper-block-main').css({
                        'z-index': '20'
                    });
                    $('.j-stage-block-main').css({
                        'transform': 'translate3d(0,0,0)'
                    });
                    $('.j-stage-box-earth').click(function () {
                        step = 3;
                        var $this = $(this);
                        if ($this.hasClass('no')) return;
                        $this.addClass('shake no');
                        var bi1 = new MakeBreakImg({
                            el: $('.j-stage-img-earth')
                        });
                        var bi2 = new MakeBreakImg({
                            el:  $('.j-wrapper-img-back'),
                            strStyle: 'position: relative;z-index: 10;opacity: 0.5',
                            itemSpl: 10
                        });

                        makeSky.backToStart(function () {
                            $('.j-wrapper-cvs').fadeOut(1000);
                            $('#j-wrapper-block-back').css('perspective','none');

                            bi1.makeBreak();
                            bi2.makeBreak();
                            mv.slow();

                            setTimeout(function () {
                                $('.j-sky-block').remove();
                                $('.j-intro-block').removeClass('hide');
                                setTimeout(resolve,2000);
                            }, 1000);
                        });
                    });

                }
            });

            var timeSeed = 0;
            window.onresize = function () {
                timeSeed && clearTimeout(timeSeed);
                timeSeed = setTimeout(function () {
                    makeSky.restart();
                }, 200);
            };

            setTimeout(function () {
                document.getElementsByClassName('j-welcome-block')[0].remove();
            }, 2000);
        }

        document.getElementsByClassName('j-welcome-box-btn')[0].addEventListener('click',function () {
            if(!Cookie.get('finished')){
                Cookie.set('finished','1',1);
            }
            runPrefixMethod(document.documentElement, "RequestFullScreen");
            step2();
            step2 = null;
        });

        document.body.addEventListener("dblclick", function() {
            if (runPrefixMethod(document, "FullScreen") || runPrefixMethod(document, "IsFullScreen")) {
                runPrefixMethod(document, "CancelFullScreen");
            } else {
                runPrefixMethod(document.documentElement, "RequestFullScreen");
            }
        });

    });

    prmFirst.then(function () {
        return new Promise(function (resolve) {
            var code =
                `
/* ......
* 厉害了我的哥，这下玩坏了吧！
* 没办法，那只能重新造一个网页了╮(╯_╰)╭
*/

/* 首先给所有元素加上过渡效果 */
* {
    -webkit-transition: all .3s;
    transition: all .3s;
}
/* 还是用绚烂的星空背景才有逼格 */
html,body {
    background-image: url("//t.cn/Raa7dxT");
    color: #333;
}
/* 好歹还是加个边框吧 */
.display-block {
    padding: 10px;
    border: 2px solid rgb(0,155,255);
    margin: 10px;
    overflow: auto;
    width: 400px; height: 90vh;
    float: left;
    background: rgba(0,155,255,0.5);
}
/* 还差一个版块来介绍自己 */
.intro-box{
    margin: 10px;
    padding: 12px;
    min-height: 110vh;
    overflow: hidden;
    background: rgba(0,55,205,0.3);
}
/* 使命完成了，给主要的版块让让位置吧 */
.display-block {
    transform-origin: 0 50%;
    -webkit-transform: rotateY(30deg);
    transform: rotateY(30deg);
    margin-right: -100px;
}
`;
            var idx = 0;
            var len = code.length;
            function appendStyle() {
                $('.style-block').html('<style>' + code.slice(0,idx++) + '</style>');
                $('.display-block').text(code.slice(0,idx)).scrollTop(9999);
                if(idx === len){
                    resolve();
                    return;
                }
                setTimeout(appendStyle,10);
            }
            appendStyle();
        });
    }).then(function () {
        alert('可以写简历了呀');
    });
</script>
</body>
</html>